<div class="m-4">
  <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center gap-3">
    <h2 class="m-0">User Management</h2>
    <p-button label="Add New" icon="pi pi-user-plus" (onClick)="addNew()"></p-button>
  </div>

  <p-table
    [value]="rows()"
    [loading]="loading()"
    responsiveLayout="stack"
    [breakpoint]="'960px'"
    styleClass="p-datatable-striped mt-4">

    <ng-template pTemplate="header">
      <tr>
        <th>Name</th>
        <th>Email</th>
        <th>Role</th>
        <th>Status</th>
        <th>Joined Date</th>
        <th style="width: 5rem"></th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-user>
      <tr class="cursor-pointer" (click)="openDetails(user)">
        <td>
          <span class="font-bold">{{ user.name }}</span>
        </td>
        <td>{{ user.email }}</td>
        <td>
          <p-tag
            [severity]="user.role === 'OWNER' ? 'success' : 'info'"
            [value]="user.role">
          </p-tag>
        </td>
        <td>
          <p-tag
            [severity]="user.status === 'ACTIVE' || user.status === 'active'  ? 'success' : 'danger'"
            [value]="user.status | uppercase">
          </p-tag>
        </td>
        <td>{{ user.createdAt | date:'mediumDate' }}</td>
        <td>
          <p-button
            icon="pi pi-pencil"
            [rounded]="true"
            styleClass="p-button-text"
            severity="secondary">
          </p-button>
        </td>
        <td>
          <p-button
            icon="pi pi-user-minus"
            [rounded]="true"
            styleClass="p-button-text"
            severity="danger"
            pTooltip="Deactivate User"
            tooltipPosition="left"
            (onClick)="$event.stopPropagation(); deactivateUser(user)">
          </p-button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center p-4">No users found for this organization.</td>
      </tr>
    </ng-template>
  </p-table>

  @if (error()) {
  <div class="mt-3 p-3 border-round bg-red-50 text-red-700 flex align-items-center gap-2">
    <i class="pi pi-exclamation-circle"></i>
    <span>{{ error() }}</span>
  </div>
  }

  <p-dialog
    header="Add New User"
    [(visible)]="displayModal"
    [modal]="true"
    [style]="{ width: '450px' }"
    [draggable]="false"
    [resizable]="false">

    <form [formGroup]="userForm" (ngSubmit)="saveUser()" class="flex flex-column gap-3 mt-3">
      <div class="flex flex-column gap-2">
        <label for="fullName" class="font-bold">Full Name</label>
        <input pInputText id="fullName" formControlName="fullName" placeholder="Enter full name" />
      </div>

      <div class="flex flex-column gap-2">
        <label for="email" class="font-bold">Email</label>
        <input pInputText id="email" formControlName="email" placeholder="email@example.com" />
      </div>

      <div class="flex flex-column gap-2">
        <label for="password" class="font-bold">Password</label>
        <input pInputText type="password" id="password" formControlName="password" placeholder="Min 6 characters" />
      </div>

      <div class="flex justify-content-end gap-2 mt-4">
        <p-button label="Cancel" icon="pi pi-times" styleClass="p-button-text" (onClick)="displayModal.set(false)"></p-button>
        <p-button label="Save" icon="pi pi-check" [disabled]="userForm.invalid" (onClick)="saveUser()"></p-button>
      </div>
    </form>
  </p-dialog>
</div>
