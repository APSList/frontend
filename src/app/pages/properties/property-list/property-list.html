<!-- property-list.html -->

<div class="mx-4 my-4">
  <!-- Header -->
  <div class="flex flex-column md:flex-row md:justify-content-between md:align-items-center gap-3">
    <div>
      <h2 class="m-0">Properties</h2>
      <div class="text-600 text-sm mt-1">Manage your properties (details are inside each property).</div>
    </div>

    <div class="flex gap-2">
      <p-button label="Add new" icon="pi pi-plus" (onClick)="create()"></p-button>

      <p-button
        icon="pi pi-refresh"
        severity="secondary"
        text
        pTooltip="Refresh"
        tooltipPosition="bottom"
        (onClick)="reload()">
      </p-button>
    </div>
  </div>

  <!-- Filters -->
  <div class="mt-4 flex flex-column gap-3 md:flex-row md:align-items-center md:flex-wrap">
    <div class="w-full md:flex-1 md:min-w-20rem">
      <p-iconfield iconPosition="left" class="w-full">
        <p-inputicon class="pi pi-search"></p-inputicon>
        <input
          pInputText
          class="w-full"
          placeholder="Search by name"
          [ngModel]="nameFilter()"
          (ngModelChange)="onNameInput($event)"
        />
      </p-iconfield>
    </div>

    <input
      pInputText
      class="w-full md:w-14rem"
      placeholder="Country"
      [value]="countryFilter()"
      (input)="onCountryInput($any($event.target).value)"
    />

    <p-select
      class="w-full md:w-12rem"
      [options]="statusOptions"
      optionLabel="label"
      optionValue="value"
      placeholder="Status"
      showClear
      [ngModel]="statusFilter()"
      (onChange)="onStatusChange($event.value)">
    </p-select>

    <p-button
      class="w-full md:w-auto md:ml-auto"
      label="Clear"
      icon="pi pi-filter-slash"
      severity="secondary"
      outlined
      (onClick)="clearFilters()">
    </p-button>
  </div>

  <!-- Error -->
  @if (error()) {
    <div class="mt-3 p-3 border-round bg-red-50 text-red-700">
      {{ error() }}
    </div>
  }

  <!-- Table -->
  <p-table
    class="mt-4"
    [value]="rows()"
    dataKey="id"
    [loading]="loading()"
    [rowHover]="true"
    breakpoint="768px"
    sortMode="single"
    [sortField]="sortField()"
    [sortOrder]="sortOrder()"

    [customSort]="true"
    (sortFunction)="onSortFunction($event)"
  >
    <ng-template pTemplate="header">
      <tr>
        <th pSortableColumn="name">
          Name <p-sortIcon field="name"></p-sortIcon>
        </th>

        <th pSortableColumn="country">
          Location <p-sortIcon field="country"></p-sortIcon>
        </th>

        <th pSortableColumn="maxGuests" class="text-center">
          Capacity <p-sortIcon field="maxGuests"></p-sortIcon>
        </th>

        <th pSortableColumn="pricePerPersonDay" class="text-right">
          Price <p-sortIcon field="pricePerPersonDay"></p-sortIcon>
        </th>

        <th pSortableColumn="status" class="text-center">
          Status <p-sortIcon field="status"></p-sortIcon>
        </th>

        <th pSortableColumn="updatedAt">
          Updated <p-sortIcon field="updatedAt"></p-sortIcon>
        </th>

        <th style="width: 4rem"></th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-p>
      <tr class="cursor-pointer" (click)="openDetails(p)">
        <!-- Name -->
        <td>
          <div class="font-medium">{{ p.name }}</div>
          @if (typeLabel(p)) {
            <div class="text-600 text-sm">
              {{ typeLabel(p) }}
            </div>
          }
        </td>

        <!-- Location -->
        <td>
          <div class="font-medium">{{ p.country ?? '—' }}</div>
          @if (p.address) {
            <div class="text-600 text-sm">{{ p.address }}</div>
          }
        </td>

        <!-- Capacity -->
        <td class="text-center md:text-center">
          <div class="font-medium">{{ p.maxGuests ?? '?' }}</div>
          <div class="text-600 text-sm hidden md:block">
            {{ capacityLabel(p) }}
          </div>
        </td>

        <!-- Price -->
        <td class="text-right">
          <div class="font-medium">
            {{ (p.pricePerPersonDay ?? null) === null ? '—' : (p.pricePerPersonDay | currency:'EUR':'symbol':'1.0-2') }}
          </div>

          @if (p.dennyFee !== null && p.dennyFee !== undefined) {
            <div class="text-600 text-sm">
              Fee: {{ p.dennyFee | currency:'EUR':'symbol':'1.0-2' }}
            </div>
          }
        </td>

        <!-- Status -->
        <td class="text-center">
          <p-tag [value]="p.status" [severity]="statusSeverity(p.status)"></p-tag>
        </td>

        <!-- Updated -->
        <td>
          <div class="font-medium">
            {{ p.updatedAt ? (p.updatedAt | date:'mediumDate') : '—' }}
          </div>
          @if (p.updatedBy) {
            <div class="text-600 text-sm">by {{ p.updatedBy }}</div>
          }
        </td>

        <!-- Actions -->
        <td class="text-right">
          <p-button
            icon="pi pi-trash"
            severity="danger"
            text
            pTooltip="Delete"
            tooltipPosition="left"
            (onClick)="$event.stopPropagation(); delete(p.id)">
          </p-button>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7" class="text-center p-4 text-600">
          No properties found.
        </td>
      </tr>
    </ng-template>
  </p-table>
</div>
