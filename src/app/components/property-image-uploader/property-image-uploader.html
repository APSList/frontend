<p-toast></p-toast>

<p-card class="border-round-2xl shadow-2 surface-card overflow-hidden mb-4">
  <ng-template pTemplate="header">
    <div class="flex justify-content-between align-items-center px-4 pt-4">
      <div class="flex align-items-center gap-3">
        <span class="font-semibold text-lg text-900">Photos</span>

        <!-- ✅ zelen badge -->
        <p-badge
          [value]="previewUrls().length"
          severity="success"
          class="border-round-xl">
        </p-badge>
      </div>

      @if (editable && (previewUrls().length !== 0)) {
        <p-button
          icon="pi pi-upload"
          label="Add photos"
          severity="secondary"
          rounded
          (onClick)="openUpload()">
        </p-button>
      }
    </div>
  </ng-template>

  <div class="px-4 pb-4">
    @if (previewUrls().length === 0) {
      <div class="border-1 border-200 border-round-xl p-6 flex flex-column align-items-center justify-content-center text-center">
        <i class="pi pi-images text-300" style="font-size: 2.5rem;"></i>
        <div class="mt-3 font-semibold text-800">No photos yet</div>
        <div class="text-600 mt-1">Upload photos to show them here.</div>

        @if (editable) {
          <p-button class="mt-4" icon="pi pi-upload" label="Upload photos" rounded (onClick)="openUpload()"></p-button>
        }
      </div>
    } @else {
      <p-galleria
        class="pretty-galleria border-round-2xl overflow-hidden shadow-1"
        [value]="previewUrls()"
        [circular]="true"
        [showItemNavigators]="false"
        [showIndicators]="true"
        [showThumbnails]="false"
        [(activeIndex)]="activeIndexModel">

        <!-- PrimeNG v21 primeri uporabljajo #item; to je najbolj kompatibilno -->
        <ng-template #item let-image>
          <div class="relative w-full" style="height: 28rem;">
            <img [src]="image" class="w-full h-full" style="object-fit: cover;" />
          </div>
        </ng-template>

      </p-galleria>

    }
  </div>
</p-card>

<p-dialog
  header="Upload photos"
  [visible]="uploadDialogOpen()"
  [modal]="true"
  [dismissableMask]="true"
  [style]="{ width: 'min(860px, 95vw)' }"
  (onHide)="closeUpload()">

  <p-fileUpload
    name="images[]"
    mode="advanced"
    [multiple]="true"
    accept="image/*"
    [maxFileSize]="maxUploadBytes"
    [customUpload]="true"
    (onSelect)="onSelectedFiles($event)"
    (uploadHandler)="onTemplatedUpload($event)">

    <ng-template
      pTemplate="header"
      let-files
      let-chooseCallback="chooseCallback"
      let-clearCallback="clearCallback"
      let-uploadCallback="uploadCallback">

      <div class="flex flex-wrap justify-content-between align-items-center flex-1 gap-2">
        <div class="flex gap-2">
          <p-button icon="pi pi-images" [rounded]="true" [outlined]="true" (onClick)="choose($event, chooseCallback)"></p-button>

          <p-button
            icon="pi pi-cloud-upload"
            severity="success"
            [rounded]="true"
            [outlined]="true"
            [disabled]="!files || files.length === 0"
            (onClick)="uploadEvent(uploadCallback)">
          </p-button>

          <p-button
            icon="pi pi-times"
            severity="danger"
            [rounded]="true"
            [outlined]="true"
            [disabled]="!files || files.length === 0"
            (onClick)="clearCallback()">
          </p-button>
        </div>

        <div style="min-width: 14rem;" class="ml-auto">
          <p-progressBar [value]="totalSizePercent()" [showValue]="false"></p-progressBar>
          <div class="text-600 text-sm mt-1">
            {{ formatSize(totalSize()) }} / {{ formatSize(maxUploadBytes) }}
          </div>
        </div>
      </div>
    </ng-template>

    <ng-template pTemplate="content" let-files let-removeFileCallback="removeFileCallback">
      <div class="flex flex-column gap-4 pt-3">
        @if (files?.length > 0) {
          <div class="font-semibold mb-2">Pending</div>

          <div class="flex flex-wrap gap-3">
            @for (file of files; track $index) {
              <div class="border-1 border-200 border-round-xl p-3 flex flex-column align-items-center gap-2 shadow-1"
                   style="width: 11rem;">
                <img
                  [alt]="file.name"
                  [src]="file.objectURL"
                  width="140"
                  height="90"
                  style="object-fit: cover; border-radius: .75rem;"
                />
                <div class="font-semibold text-900" style="max-width: 10rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                  {{ file.name }}
                </div>
                <div class="text-600 text-sm">{{ formatSize(file.size) }}</div>
                <p-badge value="Pending" severity="warn"></p-badge>
                <p-button
                  icon="pi pi-times"
                  severity="danger"
                  [outlined]="true"
                  [rounded]="true"
                  (onClick)="onRemoveTemplatingFile($event, file, removeFileCallback, $index)">
                </p-button>
              </div>
            }
          </div>
        }
      </div>
    </ng-template>

    <ng-template pTemplate="empty">
      <div class="flex align-items-center justify-content-center flex-column py-6">
        <i class="pi pi-cloud-upload text-300" style="font-size: 2.25rem;"></i>
        <p class="mt-3 mb-0 text-700">Drag and drop files here to upload.</p>
        <p class="mt-1 mb-0 text-500 text-sm">Supported: images • Max size: {{ formatSize(maxUploadBytes) }}</p>
      </div>
    </ng-template>

  </p-fileUpload>
</p-dialog>
